
**线程的栈 (Thread Stack) 存放在进程的** **内存映射区 (Memory Mapping Segment) 或堆 (Heap) 区域中。**

### 1. 进程主栈 vs. 线程栈

在一个传统的单线程进程中，只有一个**主栈 (Main Stack)**，它位于进程虚拟地址空间的**栈 (Stack) 区域**（通常在高地址，并向低地址增长）。

但是，当一个进程创建多个线程（Multi-threading）时：

- **进程是资源分配的基本单位：** 所有线程共享进程的绝大多数资源，包括**堆、代码段、数据段和 BSS 段**。
    
- **线程是调度的基本单位：** 每个线程必须有自己独立的一套执行状态，其中最重要的就是**栈**。
    

为了确保线程之间函数调用和局部变量的独立性，**操作系统必须为每个线程分配一个独立的栈空间。**

### 2. 线程栈的存放位置

操作系统内核或用户空间的线程库（如 POSIX Pthreads）通常采用以下方式为新创建的线程分配栈空间：

#### **主要位置：内存映射区 (Memory Mapping Segment)**

这是现代操作系统（如 Linux）中最常见和推荐的做法：

1. 当创建一个新线程时，操作系统会使用类似 `mmap()` 的机制，在进程的虚拟地址空间中划出一块区域作为该线程的栈。
    
2. 这块区域通常位于**堆 (Heap) 和主栈 (Main Stack) 之间**的**内存映射区**。
    

**这样做的优势：**

- **隔离性好：** 内存映射通常会以**页对齐**的方式分配，并且操作系统可以在每个线程栈的末尾（或起始处）设置一个**保护页 (Guard Page)**。
    
- **内存保护：** 任何线程试图访问其栈区以外的地址（即发生栈溢出时），都会立即触发对保护页的访问，导致**段错误 (Segmentation Fault)**，从而保护其他线程的栈区不受破坏。
    

#### **次要或历史位置：堆 (Heap)**

在某些线程库实现或特定情况下，线程栈可能会被简单地视为一大块动态分配的内存，从**堆**中划分出来。但这不如使用 `mmap` 分配并设置保护页来得规范和安全。

### 总结图示

假设进程有一个主栈（Main Stack）和两个额外线程（Thread A 和 Thread B），它们的内存布局看起来是这样的：

```
+---------------------------+  <-- 高地址
| 命令行参数 / 环境变量     |
+---------------------------+
| Stack (主线程 Main Stack) | <--- 向低地址增长
|          ↓                |
+---------------------------+
|      [未分配空间]         |
|                           |
| +-----------------------+ |
| | Thread B Stack      | |
| +-----------------------+ |
| | Thread B Guard Page | |  <- 线程 B 的栈
| +-----------------------+ |
|                           |
| +-----------------------+ |
| | Thread A Stack      | |
| +-----------------------+ |
| | Thread A Guard Page | |  <- 线程 A 的栈
| +-----------------------+ |
|                           |
| Memory Mapping Segment    |  <-- 动态库、mmap文件等
|                           |
+---------------------------+
| Heap (共享)               | <--- 向高地址增长
|          ↑                |
+---------------------------+
| BSS 段 (共享)             |
+---------------------------+
| Data 段 (共享)            |
+---------------------------+
| Text/Code 段 (共享)       |  <-- 低地址
+---------------------------+
```

因此，每个线程都有自己**私有的栈**，但这些栈都“寄居”在**进程共享的虚拟地址空间**中，通常位于**内存映射区**，以获得更好的管理和保护。